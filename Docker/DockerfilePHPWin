# Imagen base de Windows Server Core con IIS
FROM mcr.microsoft.com/windows/servercore:ltsc2019

SHELL ["powershell", "-Command", "$ErrorActionPreference = 'Stop';"]

RUN Install-WindowsFeature -Name Web-Server

# Download and install PHP
ENV VERSION=8.4.8
ENV PHP_DIR=C:\php

RUN Invoke-WebRequest  -Uri $('https://windows.php.net/downloads/releases/php-{0}-Win32-vs17-x64.zip' -f $env:VERSION) -OutFile "C:\\php.zip" ; \
    Expand-Archive -Path C:\php.zip -DestinationPath $env:PHP_DIR ; \
    Remove-Item C:\php.zip

# Install VSC++ Redistributable
RUN Invoke-WebRequest   -Uri "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile "C:\\vc_redist.x64.exe" ; \
  Start-Process -FilePath "C:\\vc_redist.x64.exe" -ArgumentList "/install", "/quiet", "/norestart" -Wait ; \
  Remove-Item "C:\\vc_redist.x64.exe"

# --- COPIAR PHP.INI DE EJEMPLO ---
RUN Copy-Item "$env:PHP_DIR\\php.ini-development" "$env:PHP_DIR\\php.ini"

# --- CONFIGURAR IIS PARA PHP ---
RUN Import-Module WebAdministration ; \
    New-Item -Path IIS:\AppPools\PHPAppPool ; \
    Set-ItemProperty 'IIS:\AppPools\PHPAppPool' -Name managedRuntimeVersion -Value '' ; \
    Set-ItemProperty 'IIS:\AppPools\PHPAppPool' -Name enable32BitAppOnWin64 -Value False ; \
    Set-ItemProperty 'IIS:\Sites\Default Web Site' -Name applicationPool -Value 'PHPAppPool' ; \
    Add-WebConfigurationProperty -pspath 'MACHINE/WEBROOT/APPHOST' -filter 'system.webServer/fastCgi' -name '.' -value @{fullPath='C:\php\php-cgi.exe'} ; \ 
    Set-Content -Path 'C:\inetpub\wwwroot\index.php' -Value '<?php phpinfo(); ?>' ; \
    Add-WebConfigurationProperty -PSPath "MACHINE/WEBROOT/APPHOST" -Filter "system.webServer/defaultDocument/files" -Name "." -Value @{value='index.php'}

# Copy the files to the container
COPY Frontend/public/ C:/inetpub/wwwroot/
COPY PHPWebapp/ C:/inetpub/wwwroot/api/
COPY PHPWebapp/web.config C:/inetpub/wwwroot/web.config

EXPOSE 80

# Start IIS and keep the container running
CMD ["powershell", "-Command", "Start-Service W3SVC; Wait-Event -SourceIdentifier DockerStopEvent"]
